<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>levelQ</title>
  <style>
    html, body { margin: 0; height: 100%; background:#111; overflow:hidden; }
    canvas { display:block; width:100vw; height:100vh; }
  </style>
</head>
<body>
<canvas id="c"></canvas>
<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(innerWidth * dpr);
  canvas.height = Math.floor(innerHeight * dpr);
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
addEventListener("resize", resize);
resize();

let manifest = null;
let tileImages = [];
let tileSize = 512;

const player = { x: 100, speed: 3 };
let cameraX = 0;

const keys = new Set();
addEventListener("keydown", e => keys.add(e.key));
addEventListener("keyup", e => keys.delete(e.key));

async function loadManifest() {
  const res = await fetch("./manifest.json", { cache: "no-store" });
  manifest = await res.json();
  tileSize = manifest.tileSize || 512;
  tileImages = await Promise.all((manifest.tiles || []).map(src => loadImage(src)));
}

function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src + "?v=" + Date.now(); // bust cache
  });
}

function worldWidth() {
  return tileImages.length * tileSize;
}

function update() {
  let vx = 0;
  if (keys.has("ArrowLeft")) vx = -player.speed;
  if (keys.has("ArrowRight")) vx = player.speed;

  player.x = Math.max(0, Math.min(player.x + vx, Math.max(0, worldWidth() - 20)));

  const target = player.x - innerWidth * 0.5;
  cameraX += (target - cameraX) * 0.08;
  cameraX = Math.max(0, Math.min(cameraX, Math.max(0, worldWidth() - innerWidth)));
}

function draw() {
  ctx.clearRect(0, 0, innerWidth, innerHeight);

  const groundY = innerHeight - tileSize;
  for (let i = 0; i < tileImages.length; i++) {
    const x = i * tileSize - cameraX;
    if (x > innerWidth || x + tileSize < 0) continue;
    ctx.drawImage(tileImages[i], x, groundY, tileSize, tileSize);
  }

  // player (placeholder)
  const px = player.x - cameraX;
  const py = innerHeight - 80;
  ctx.fillStyle = "white";
  ctx.fillRect(px, py, 20, 40);

  ctx.fillStyle = "rgba(255,255,255,0.75)";
  ctx.font = "14px system-ui";
  ctx.fillText(`tiles: ${tileImages.length}  x: ${Math.floor(player.x)}`, 12, 22);
}

function loop() {
  if (manifest) { update(); draw(); }
  requestAnimationFrame(loop);
}

(async function main(){
  await loadManifest();
  loop();
})();
</script>
</body>
</html>
